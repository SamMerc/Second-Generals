<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Forward-Backward KNN Refinement</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;600&family=Syne:wght@400;700;800&display=swap');

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: #0a0a0f;
    color: #e0e0f0;
    font-family: 'JetBrains Mono', monospace;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 24px 20px;
  }

  h1 {
    font-family: 'Syne', sans-serif;
    font-weight: 800;
    font-size: 1.5rem;
    letter-spacing: -0.03em;
    color: #fff;
    margin-bottom: 4px;
  }

  .subtitle {
    font-size: 0.68rem;
    color: #555;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-bottom: 20px;
  }

  .container {
    display: flex;
    gap: 10px;
    width: 100%;
    max-width: 1160px;
    align-items: flex-start;
  }

  .panel {
    flex: 1;
    background: #0f0f1a;
    border: 1px solid #1e1e35;
    border-radius: 12px;
    overflow: hidden;
  }

  .panel-header {
    padding: 10px 16px;
    border-bottom: 1px solid #1e1e35;
    display: flex;
    align-items: center;
    gap: 10px;
    justify-content: space-between;
  }

  .panel-header-left { display: flex; align-items: center; gap: 10px; }

  .panel-label {
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 0.85rem;
    letter-spacing: 0.05em;
  }

  .x-label { color: #4fc3f7; }
  .y-label { color: #a78bfa; }

  .space-tag {
    font-size: 0.58rem;
    color: #333;
    background: #1a1a2e;
    padding: 2px 8px;
    border-radius: 20px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }

  .zoom-controls {
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .zoom-btn {
    width: 24px; height: 24px;
    background: #1a1a2e;
    border: 1px solid #2a2a4a;
    color: #aaa;
    font-size: 14px;
    border-radius: 5px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s;
    font-family: monospace;
  }
  .zoom-btn:hover { background: #22223a; color: #fff; border-color: #4a4a7a; }

  .zoom-level {
    font-size: 0.6rem;
    color: #444;
    min-width: 34px;
    text-align: center;
  }

  canvas {
    display: block;
    width: 100%;
    cursor: grab;
  }
  canvas:active { cursor: grabbing; }

  .hint {
    font-size: 0.56rem;
    color: #2a2a40;
    text-align: center;
    padding: 4px;
    letter-spacing: 0.06em;
  }

  .controls {
    display: flex;
    flex-direction: column;
    gap: 8px;
    width: 168px;
    flex-shrink: 0;
  }

  .iter-display {
    background: #0f0f1a;
    border: 1px solid #1e1e35;
    border-radius: 12px;
    padding: 14px;
    text-align: center;
  }

  .iter-number {
    font-family: 'Syne', sans-serif;
    font-size: 2.4rem;
    font-weight: 800;
    color: #fff;
    line-height: 1;
  }

  .iter-label {
    font-size: 0.58rem;
    color: #444;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    margin-top: 4px;
  }

  .btn {
    background: #1a1a2e;
    border: 1px solid #2a2a4a;
    color: #e0e0f0;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.7rem;
    padding: 9px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.15s;
    text-align: center;
    letter-spacing: 0.04em;
  }
  .btn:hover { background: #22223a; border-color: #4a4a7a; }
  .btn.primary { background: #1a1040; border-color: #5b4fcf; color: #a78bfa; }
  .btn.primary:hover { background: #22154a; border-color: #7c6fef; }
  .btn.green { background: #0f1f0f; border-color: #1e4a1e; color: #34d399; }
  .btn.green:hover { background: #122212; border-color: #34d399; }

  .section {
    background: #0f0f1a;
    border: 1px solid #1e1e35;
    border-radius: 12px;
    padding: 12px;
  }

  .section-title {
    font-size: 0.58rem;
    color: #444;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    margin-bottom: 10px;
  }

  .slider-row {
    display: flex;
    flex-direction: column;
    gap: 5px;
    margin-bottom: 10px;
  }
  .slider-row:last-of-type { margin-bottom: 8px; }

  .slider-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .slider-name { font-size: 0.65rem; color: #888; }
  .slider-value { font-size: 0.72rem; color: #e0e0f0; font-weight: 600; }

  input[type=range] {
    width: 100%;
    height: 4px;
    -webkit-appearance: none;
    background: #1e1e35;
    border-radius: 2px;
    outline: none;
    cursor: pointer;
  }
  input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 13px; height: 13px;
    border-radius: 50%;
    background: #a78bfa;
    cursor: pointer;
  }
  input[type=range]::-webkit-slider-thumb:hover { background: #c4b5fd; }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 7px;
    font-size: 0.62rem;
    color: #777;
    margin-bottom: 6px;
  }
  .legend-item:last-child { margin-bottom: 0; }

  .legend-dot {
    width: 9px; height: 9px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .step-info {
    background: #0f0f1a;
    border: 1px solid #1e1e35;
    border-radius: 12px;
    padding: 12px;
    font-size: 0.62rem;
    color: #666;
    line-height: 1.75;
    min-height: 74px;
  }
  .step-info span { color: #a78bfa; }

  .bottom-bar {
    width: 100%;
    max-width: 1160px;
    margin-top: 10px;
    display: flex;
    gap: 6px;
    align-items: center;
  }

  .progress-track {
    flex: 1; height: 3px;
    background: #1a1a2e;
    border-radius: 2px;
    overflow: hidden;
  }
  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #4fc3f7, #a78bfa);
    border-radius: 2px;
    transition: width 0.3s ease;
  }

  .iter-dots { display: flex; gap: 4px; flex-wrap: wrap; max-width: 160px; }
  .iter-dot {
    width: 5px; height: 5px;
    border-radius: 50%;
    background: #1e1e35;
    transition: background 0.2s;
  }
  .iter-dot.active { background: #a78bfa; }
  .iter-dot.done   { background: #4fc3f7; }
</style>
</head>
<body>

<h1>Forward-Backward KNN Refinement</h1>
<p class="subtitle">Neighbourhood evolution across iterations</p>

<div class="container">

  <!-- X Space -->
  <div class="panel">
    <div class="panel-header">
      <div class="panel-header-left">
        <span class="panel-label x-label">X Space</span>
        <span class="space-tag">Input manifold</span>
      </div>
      <div class="zoom-controls">
        <button class="zoom-btn" onclick="zoomCanvas('X', 1.35)">+</button>
        <span class="zoom-level" id="zoomLabelX">1.0×</span>
        <button class="zoom-btn" onclick="zoomCanvas('X', 1/1.35)">−</button>
        <button class="zoom-btn" title="Reset view" onclick="resetView('X')" style="font-size:10px">⌂</button>
      </div>
    </div>
    <canvas id="canvasX" width="460" height="400"></canvas>
    <div class="hint">scroll to zoom · drag to pan</div>
  </div>

  <!-- Controls -->
  <div class="controls">
    <div class="iter-display">
      <div class="iter-number" id="iterNum">0</div>
      <div class="iter-label">iteration</div>
    </div>

    <button class="btn primary" id="btnNext">next step →</button>
    <button class="btn" id="btnPrev">← prev</button>
    <button class="btn" id="btnAuto">auto play</button>
    <button class="btn" id="btnReset">reset</button>

    <div class="section">
      <div class="section-title">Parameters</div>
      <div class="slider-row">
        <div class="slider-header">
          <span class="slider-name">K neighbours</span>
          <span class="slider-value" id="valK">8</span>
        </div>
        <input type="range" id="sliderK" min="3" max="20" value="8" step="1"
          oninput="document.getElementById('valK').textContent=this.value">
      </div>
      <div class="slider-row">
        <div class="slider-header">
          <span class="slider-name">Iterations</span>
          <span class="slider-value" id="valIter">6</span>
        </div>
        <input type="range" id="sliderIter" min="1" max="12" value="6" step="1"
          oninput="document.getElementById('valIter').textContent=this.value">
      </div>
      <button class="btn green" id="btnRebuild">↺ rebuild</button>
    </div>

    <div class="section">
      <div class="section-title">Legend</div>
      <div class="legend-item"><div class="legend-dot" style="background:#fff;box-shadow:0 0 5px #fff"></div>query Xq / Yq</div>
      <div class="legend-item"><div class="legend-dot" style="background:#1e2a3a;border:1px solid #2a3a4a"></div>training pts</div>
      <div class="legend-item"><div class="legend-dot" style="background:#f97316"></div>current nbrs</div>
      <div class="legend-item"><div class="legend-dot" style="background:#a78bfa"></div>XhSel (backward)</div>
      <div class="legend-item"><div class="legend-dot" style="background:#f9731699"></div>YhSel (forward)</div>
      <div class="legend-item"><div class="legend-dot" style="background:#34d399"></div>new neighbours</div>
      <div class="legend-item"><div class="legend-dot" style="background:#fbbf24"></div>Ym (mean Y)</div>
    </div>

    <div class="step-info" id="stepInfo">Press <span>next step</span> to begin.</div>
  </div>

  <!-- Y Space -->
  <div class="panel">
    <div class="panel-header">
      <div class="panel-header-left">
        <span class="panel-label y-label">Y Space</span>
        <span class="space-tag">Output manifold</span>
      </div>
      <div class="zoom-controls">
        <button class="zoom-btn" onclick="zoomCanvas('Y', 1.35)">+</button>
        <span class="zoom-level" id="zoomLabelY">1.0×</span>
        <button class="zoom-btn" onclick="zoomCanvas('Y', 1/1.35)">−</button>
        <button class="zoom-btn" title="Reset view" onclick="resetView('Y')" style="font-size:10px">⌂</button>
      </div>
    </div>
    <canvas id="canvasY" width="460" height="400"></canvas>
    <div class="hint">scroll to zoom · drag to pan</div>
  </div>

</div>

<div class="bottom-bar">
  <div class="iter-dots" id="iterDots"></div>
  <div class="progress-track">
    <div class="progress-fill" id="progressFill" style="width:0%"></div>
  </div>
</div>

<script>
// ─── RNG ─────────────────────────────────────────────────────────────────────
const rng = (() => {
  let x = 42;
  return () => { x = (x * 1664525 + 1013904223) & 0xffffffff; return (x >>> 0) / 0xffffffff; };
})();

// ─── Data ─────────────────────────────────────────────────────────────────────
const N = 300;
const Xpts = Array.from({length: N}, () => {
  const t = rng() * 2 * Math.PI, r = 0.6 + rng() * 0.25;
  return { x: r*Math.cos(t) + 0.08*(rng()-0.5), y: r*Math.sin(t) + 0.08*(rng()-0.5) };
});
const Ypts = Xpts.map(p => ({
  x: p.x*Math.cos(p.x*0.8) - p.y*0.4 + 0.15*(rng()-0.5),
  y: p.x*Math.sin(p.y*0.8) + p.x*0.3 + 0.15*(rng()-0.5),
}));
const Xq = { x: 0.55, y: 0.35 };
// True output query point — same deterministic mapping as Ypts but without noise
const Yq = {
  x: Xq.x * Math.cos(Xq.x * 0.8) - Xq.y * 0.4,
  y: Xq.x * Math.sin(Xq.y * 0.8) + Xq.x * 0.3,
};

// ─── Viewport ─────────────────────────────────────────────────────────────────
const VP = {
  X: { scale: 155, cx: 0, cy: 0 },
  Y: { scale: 155, cx: 0, cy: 0 },
};

function toScreen(p, W, H, vp) {
  return { x: W/2 + (p.x - vp.cx)*vp.scale, y: H/2 - (p.y - vp.cy)*vp.scale };
}

function zoomCanvas(which, factor, pivot) {
  const vp = VP[which];
  const canvas = which === 'X' ? cX : cY;
  const W = canvas.width, H = canvas.height;
  const px = pivot ? pivot.x : W/2;
  const py = pivot ? pivot.y : H/2;
  const wx = (px - W/2) / vp.scale + vp.cx;
  const wy = -(py - H/2) / vp.scale + vp.cy;
  vp.scale *= factor;
  vp.cx = wx - (px - W/2) / vp.scale;
  vp.cy = wy + (py - H/2) / vp.scale;
  document.getElementById('zoomLabel' + which).textContent = (vp.scale/155).toFixed(1) + '×';
  render();
}

function resetView(which) {
  VP[which] = { scale: 155, cx: 0, cy: 0 };
  document.getElementById('zoomLabel' + which).textContent = '1.0×';
  render();
}

// Scroll zoom
['canvasX','canvasY'].forEach(id => {
  const which = id === 'canvasX' ? 'X' : 'Y';
  document.getElementById(id).addEventListener('wheel', e => {
    e.preventDefault();
    const el = e.currentTarget;
    const rect = el.getBoundingClientRect();
    const sr = el.width / rect.width;
    zoomCanvas(which, e.deltaY < 0 ? 1.12 : 1/1.12, {
      x: (e.clientX - rect.left)*sr,
      y: (e.clientY - rect.top)*sr,
    });
  }, { passive: false });
});

// Drag pan
['canvasX','canvasY'].forEach(id => {
  const which = id === 'canvasX' ? 'X' : 'Y';
  const el = document.getElementById(id);
  let drag = false, last = null;
  el.addEventListener('mousedown',  e => { drag = true; last = {x:e.clientX,y:e.clientY}; });
  window.addEventListener('mouseup', () => { drag = false; });
  window.addEventListener('mousemove', e => {
    if (!drag) return;
    const rect = el.getBoundingClientRect();
    const sr = el.width / rect.width;
    VP[which].cx -= (e.clientX - last.x)*sr / VP[which].scale;
    VP[which].cy += (e.clientY - last.y)*sr / VP[which].scale;
    last = {x:e.clientX,y:e.clientY};
    render();
  });
  // Touch
  let lastTouch = null;
  el.addEventListener('touchstart', e => { if (e.touches.length===1) lastTouch={x:e.touches[0].clientX,y:e.touches[0].clientY}; },{passive:true});
  el.addEventListener('touchmove', e => {
    if (e.touches.length!==1||!lastTouch) return;
    e.preventDefault();
    const rect = el.getBoundingClientRect(), sr = el.width/rect.width;
    VP[which].cx -= (e.touches[0].clientX-lastTouch.x)*sr/VP[which].scale;
    VP[which].cy += (e.touches[0].clientY-lastTouch.y)*sr/VP[which].scale;
    lastTouch = {x:e.touches[0].clientX,y:e.touches[0].clientY};
    render();
  },{passive:false});
  el.addEventListener('touchend', () => { lastTouch=null; });
});

// ─── Algorithm ────────────────────────────────────────────────────────────────
function dist2(a,b){ return (a.x-b.x)**2+(a.y-b.y)**2; }

function knn(pts, query, k, exclude=[]) {
  return pts.map((p,i)=>({i,d:dist2(p,query)}))
    .filter(({i})=>!exclude.includes(i))
    .sort((a,b)=>a.d-b.d).slice(0,k).map(({i})=>i);
}

function meanPts(pts, idxs) {
  const n=idxs.length;
  return {x:idxs.reduce((s,i)=>s+pts[i].x,0)/n, y:idxs.reduce((s,i)=>s+pts[i].y,0)/n};
}

function applyMf(XTrSel, YTrSel, Xq) {
  return XTrSel.map((xp,i)=>({
    x: YTrSel[i].x + 0.6*(Xq.x-xp.x),
    y: YTrSel[i].y + 0.6*(Xq.y-xp.y),
  }));
}

function applyMb(XTrSel, YhSel, Ym) {
  return XTrSel.map((xp,i)=>({
    x: xp.x + 0.5*(Ym.x-YhSel[i].x),
    y: xp.y + 0.5*(Ym.y-YhSel[i].y),
  }));
}

let K=8, NUM_ITER=6, states=[], currentState=0;

function buildStates() {
  const s=[];
  let idxs = knn(Xpts, Xq, K);
  s.push({phase:'init', idxs:[...idxs], YhSel:null, XhSel:null, newIdxs:null});
  for (let iter=0; iter<NUM_ITER; iter++) {
    const XTrSel=idxs.map(i=>Xpts[i]), YTrSel=idxs.map(i=>Ypts[i]);
    const Xm=meanPts(Xpts,idxs), Ym=meanPts(Ypts,idxs);
    const YhSel=applyMf(XTrSel,YTrSel,Xq);
    s.push({phase:'forward', iter, idxs:[...idxs], YhSel, XhSel:null, Xm, Ym, newIdxs:null});
    const XhSel=applyMb(XTrSel,YhSel,Ym);
    s.push({phase:'backward', iter, idxs:[...idxs], YhSel, XhSel, Xm, Ym, newIdxs:null});
    let newIdxs=[...new Set(XhSel.map(xh=>knn(Xpts,xh,1)[0]))];
    if (newIdxs.length<K) newIdxs.push(...knn(Xpts,Xq,K-newIdxs.length,newIdxs));
    s.push({phase:'reassign', iter, idxs:[...idxs], YhSel, XhSel, Xm, Ym, newIdxs:[...newIdxs]});
    idxs=[...newIdxs];
  }
  s.push({phase:'converged', idxs:[...idxs], YhSel:null, XhSel:null, newIdxs:null});
  return s;
}
states = buildStates();

// ─── Drawing ──────────────────────────────────────────────────────────────────
const cX = document.getElementById('canvasX');
const cY = document.getElementById('canvasY');
const ctxX = cX.getContext('2d');
const ctxY = cY.getContext('2d');

function drawSpace(ctx, pts, state, isX) {
  const W=ctx.canvas.width, H=ctx.canvas.height;
  ctx.clearRect(0,0,W,H);
  const vp = isX ? VP.X : VP.Y;
  const s = p => toScreen(p,W,H,vp);
  const {idxs,YhSel,XhSel,newIdxs,phase} = state;

  // Grid
  ctx.strokeStyle='#ffffff05'; ctx.lineWidth=1;
  const step=Math.max(20, vp.scale*0.5);
  const ox=((W/2-vp.cx*vp.scale)%step+step)%step;
  const oy=((H/2+vp.cy*vp.scale)%step+step)%step;
  for(let x=ox;x<W;x+=step){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();}
  for(let y=oy;y<H;y+=step){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}

  // All pts
  pts.forEach(p=>{
    const sp=s(p);
    if(sp.x<-8||sp.x>W+8||sp.y<-8||sp.y>H+8) return;
    ctx.beginPath(); ctx.arc(sp.x,sp.y,2.5,0,Math.PI*2);
    ctx.fillStyle='#1e2a3a'; ctx.fill();
    ctx.strokeStyle='#2a3a4a'; ctx.lineWidth=0.5; ctx.stroke();
  });

  // Backward arrows (X)
  if(isX&&XhSel){
    idxs.forEach((idx,i)=>{
      const xh=XhSel[Math.min(i,XhSel.length-1)]; if(!xh) return;
      const f=s(pts[idx]),t=s(xh);
      ctx.beginPath();ctx.moveTo(f.x,f.y);ctx.lineTo(t.x,t.y);
      ctx.strokeStyle='#a78bfa33';ctx.lineWidth=1;ctx.stroke();
    });
  }

  // Forward arrows (Y)
  if(!isX&&YhSel){
    idxs.forEach((idx,i)=>{
      const yh=YhSel[Math.min(i,YhSel.length-1)]; if(!yh) return;
      const f=s(pts[idx]),t=s(yh);
      ctx.beginPath();ctx.moveTo(f.x,f.y);ctx.lineTo(t.x,t.y);
      ctx.strokeStyle='#f9731633';ctx.lineWidth=1;ctx.stroke();
    });
  }

  // Current nbrs
  const fading=!!newIdxs;
  idxs.forEach(idx=>{
    const p=s(pts[idx]);
    ctx.beginPath();ctx.arc(p.x,p.y,6,0,Math.PI*2);
    ctx.fillStyle=fading?'#f9731633':'#f97316cc'; ctx.fill();
    ctx.strokeStyle=fading?'#f9731655':'#f97316';ctx.lineWidth=1.5;ctx.stroke();
  });

  // XhSel (X)
  if(isX&&XhSel){
    XhSel.forEach(xh=>{
      const p=s(xh);
      ctx.beginPath();ctx.arc(p.x,p.y,5,0,Math.PI*2);
      ctx.fillStyle='#a78bfa88';ctx.fill();
      ctx.strokeStyle='#a78bfa';ctx.lineWidth=1.5;ctx.stroke();
    });
  }

  // YhSel (Y)
  if(!isX&&YhSel){
    YhSel.forEach(yh=>{
      const p=s(yh);
      ctx.beginPath();ctx.arc(p.x,p.y,5,0,Math.PI*2);
      ctx.fillStyle='#f9731688';ctx.fill();
      ctx.strokeStyle='#f97316';ctx.lineWidth=1.5;ctx.stroke();
    });
  }

  // New nbrs
  if(newIdxs){
    newIdxs.forEach(idx=>{
      const p=s(pts[idx]);
      ctx.beginPath();ctx.arc(p.x,p.y,7,0,Math.PI*2);
      ctx.fillStyle='#34d39955';ctx.fill();
      ctx.strokeStyle='#34d399';ctx.lineWidth=2;ctx.stroke();
    });
  }

  // Ym (Y)
  if(!isX&&state.Ym){
    const ym=s(state.Ym);
    ctx.beginPath();ctx.arc(ym.x,ym.y,5,0,Math.PI*2);
    ctx.fillStyle='#fbbf2488';ctx.fill();
    ctx.strokeStyle='#fbbf24';ctx.lineWidth=1.5;ctx.stroke();
    ctx.font='600 10px JetBrains Mono';ctx.fillStyle='#fbbf2499';
    ctx.fillText('Ym',ym.x+8,ym.y-6);
  }

  // Yq — true query point in Y space
  if(!isX){
    const qp=s(Yq);
    const g=ctx.createRadialGradient(qp.x,qp.y,0,qp.x,qp.y,18);
    g.addColorStop(0,'#ffffff33');g.addColorStop(1,'#ffffff00');
    ctx.beginPath();ctx.arc(qp.x,qp.y,18,0,Math.PI*2);ctx.fillStyle=g;ctx.fill();
    ctx.beginPath();ctx.arc(qp.x,qp.y,6,0,Math.PI*2);ctx.fillStyle='#fff';ctx.fill();
    ctx.font='600 11px JetBrains Mono';ctx.fillStyle='#fff';
    ctx.fillText('Yq',qp.x+9,qp.y-8);
  }

  // Xq (X)
  if(isX){
    const qp=s(Xq);
    const g=ctx.createRadialGradient(qp.x,qp.y,0,qp.x,qp.y,18);
    g.addColorStop(0,'#ffffff44');g.addColorStop(1,'#ffffff00');
    ctx.beginPath();ctx.arc(qp.x,qp.y,18,0,Math.PI*2);ctx.fillStyle=g;ctx.fill();
    ctx.beginPath();ctx.arc(qp.x,qp.y,6,0,Math.PI*2);ctx.fillStyle='#fff';ctx.fill();
    ctx.font='600 11px JetBrains Mono';ctx.fillStyle='#fff';
    ctx.fillText('Xq',qp.x+9,qp.y-8);
  }
}

function stepInfo(state) {
  switch(state.phase){
    case 'init':      return `<span>Initial state.</span> K=${K} nearest neighbours found around Xq in X-space.`;
    case 'forward':   return `<span>Forward (Mf).</span> Each neighbour is extrapolated toward Xq in Y-space → YhSel (orange dots).`;
    case 'backward':  return `<span>Backward (Mb).</span> YhSel residuals from Ym projected back to X-space → XhSel (purple). Inconsistent neighbours drift away.`;
    case 'reassign':  return `<span>Reassignment.</span> Each XhSel nominates its nearest training point. Consistent neighbours survive (green).`;
    case 'converged': return `<span>Converged.</span> Neighbourhood is self-consistent. Final prediction Yh = Ym + Mf*(Xq − Xm).`;
  }
}

function render() {
  const st=states[currentState];
  drawSpace(ctxX, Xpts, st, true);
  drawSpace(ctxY, Ypts, st, false);
  document.getElementById('iterNum').textContent =
    st.phase==='init'?'0': st.phase==='converged'?'✓': st.iter+1;
  document.getElementById('stepInfo').innerHTML = stepInfo(st);
  document.getElementById('iterDots').innerHTML =
    states.map((_,i)=>`<div class="iter-dot ${i<currentState?'done':i===currentState?'active':''}"></div>`).join('');
  document.getElementById('progressFill').style.width =
    `${(currentState/Math.max(1,states.length-1))*100}%`;
}

// ─── Button controls ──────────────────────────────────────────────────────────
document.getElementById('btnNext').onclick = () => { if(currentState<states.length-1){currentState++;render();} };
document.getElementById('btnPrev').onclick = () => { if(currentState>0){currentState--;render();} };
document.getElementById('btnReset').onclick = () => {
  currentState=0; render();
  if(autoTimer){clearInterval(autoTimer);autoTimer=null;document.getElementById('btnAuto').textContent='auto play';}
};

let autoTimer=null;
document.getElementById('btnAuto').onclick = function(){
  if(autoTimer){clearInterval(autoTimer);autoTimer=null;this.textContent='auto play';}
  else {
    this.textContent='pause';
    autoTimer=setInterval(()=>{
      if(currentState<states.length-1){currentState++;render();}
      else{clearInterval(autoTimer);autoTimer=null;document.getElementById('btnAuto').textContent='auto play';}
    },1300);
  }
};

document.getElementById('btnRebuild').onclick = () => {
  K = parseInt(document.getElementById('sliderK').value);
  NUM_ITER = parseInt(document.getElementById('sliderIter').value);
  if(autoTimer){clearInterval(autoTimer);autoTimer=null;document.getElementById('btnAuto').textContent='auto play';}
  states=buildStates(); currentState=0; render();
};

// Keyboard
window.addEventListener('keydown', e => {
  if(e.key==='ArrowRight') document.getElementById('btnNext').click();
  if(e.key==='ArrowLeft')  document.getElementById('btnPrev').click();
  if(e.key===' '){e.preventDefault();document.getElementById('btnAuto').click();}
});

render();
</script>
</body>
</html>
